<script>
	console.log('script is running')
  if (typeof Survey == "undefined") {
	   console.log('survey model not defined');
	}

	var resultsInfo = $( '#surveyResults' ).text();

	var result = JSON.parse(resultsInfo || '[]');

	if(result.length===0){
		console.log('no survey results');
	}

	var surveyInfoText = $( '#surveyText' ).text();

	var surveyInfo = JSON.parse(surveyInfoText || '[]');

	if(surveyInfo.competenceStandardKey === 'podd'){
		setCustomSurveyProperties();
	}

	var surveyData = surveyInfo.survey;
  console.log(surveyData);

	var survey = new Survey.Model(surveyData);

  var vispanelresults = result.map(r => r.result);
  
  var hasBooleanRadiogroupQuestions = false;

  const chartElementVisibility = surveyInfo.chartElementVisibility ? surveyInfo.chartElementVisibility : undefined;
  var elements = undefined;

  if (chartElementVisibility && !Array.isArray(chartElementVisibility)) {
      elements = chartElementVisibility.elements;
  }

  var normalizedData = vispanelresults.map(function(item) {
    survey.getAllQuestions().forEach(function(q) {
      if(q.getType()=='radiogroup'){
      	hasBooleanRadiogroupQuestions = true;
      }
      if (item[q.name] === undefined) {
        item[q.name] = "";
      } else if(item[q.name] === true && surveyInfo.competenceStandardKey !== 'podd') {
      	item[q.name] = "true"
      } else if(item[q.name] === false && surveyInfo.competenceStandardKey !== 'podd') {
      	item[q.name] = "false"
      } 
    });
    return item;
  });
  
  SurveyAnalytics.SelectBasePlotly.types = ["pie", "bar", "doughnut"];

  SurveyAnalytics.GaugePlotly.types = ["bullet"];
  SurveyAnalytics.GaugePlotly.showAsPercentage = true

	SurveyAnalytics.VisualizerBase.customColors = 
			hasBooleanRadiogroupQuestions && surveyInfo.competenceStandardKey !== 'podd' ? 
			[
                'rgba(227,6,19 ,1)',
                'rgba(0,159,227, 1)',
            ] :
			[
                'rgba(0,159,227, 1)',
                'rgba(227,6,19 ,1)',
                'rgba(249,178,51, 1)',
                'rgba(0, 0, 0, 1)',
                'rgba(18,172,19, 1)',
            ];	
    
    
  var surveyResultNode = document.getElementById("resultCharts");
	surveyResultNode.innerHTML = "";

	var filteredSurveyQuestions = survey.getAllQuestions().filter(q => q.getType() !== 'html' && q.getType() !== 'image')

	var visPanel = window.visPanel = new SurveyAnalytics.VisualizationPanel(filteredSurveyQuestions, normalizedData, 
		{allowDynamicLayout: false}, elements);

	// visPanel.allowDynamicLayout = false;
	visPanel.showHeader = true;
	
    visPanel.onStateChanged.add(function() {
      $.ajax({
          url: '/api/chartvisibility/'+surveyInfo._id,
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
          	chartElementVisibility: visPanel.state
          }),
          success: function(response){
            if(response.success){
              console.log('saved chart element visibility successfully')
              return true;
            } else {
              alert('Fout bij het bewaren van zichtbaarheid van grafieken ...' + response.message);
              return false;
            }
            
          },
          error: function(error){
            alert('Fout bij het bewaren van zichtbaarheid van grafieken ...' + error.errorThrown);
            return false;
          }
        })
    });
	
    visPanel.render(surveyResultNode);

    $('#loader').hide();
    
    window.dispatchEvent(new Event('resize'));

</script>